AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Local Development Template for Nais Auth Handler
Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: java11
Resources:
  AuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AuthFunction
      Handler: com.nais.handlers.AuthHandler::handleRequest
      Environment:
        Variables:
          AUTH_MODE: MOCK
          STAGE: dev
          AUTH_LIBRARY_VERSION: 2.1.0
          AUTH_ARCHITECTURE: amplify-like
          FRONTEND_URL: http://localhost:5173
          LOCAL_FRONTEND_URL: http://localhost:5173
          LOCAL_DEV_EMAIL: dev@example.com
          DEFAULT_TEST_EMAIL: test@example.com
          MOCK_USER_EMAIL: mock@example.com
          WORKSPACE_AUTH_ENABLED: false
          ALLOWED_EMAIL_DOMAINS: example.com,localhost
      Events:
        HealthCheck:
          Type: Api
          Properties:
            Path: /auth/health
            Method: get
        HealthCheckOptions:
          Type: Api
          Properties:
            Path: /auth/health
            Method: options
        GoogleLogin:
          Type: Api
          Properties:
            Path: /auth/google/login
            Method: get
        GoogleLoginOptions:
          Type: Api
          Properties:
            Path: /auth/google/login
            Method: options
        GoogleCallback:
          Type: Api
          Properties:
            Path: /auth/google/callback
            Method: get
        GoogleCallbackOptions:
          Type: Api
          Properties:
            Path: /auth/google/callback
            Method: options
        TokenRefresh:
          Type: Api
          Properties:
            Path: /auth/token/refresh
            Method: post
        TokenRefreshOptions:
          Type: Api
          Properties:
            Path: /auth/token/refresh
            Method: options
        Logout:
          Type: Api
          Properties:
            Path: /auth/logout
            Method: post
        LogoutOptions:
          Type: Api
          Properties:
            Path: /auth/logout
            Method: options
        WorkspaceDomains:
          Type: Api
          Properties:
            Path: /auth/workspace/domains
            Method: get
        WorkspaceDomainsOptions:
          Type: Api
          Properties:
            Path: /auth/workspace/domains
            Method: options
    Metadata:
      SamResourceId: AuthFunction
Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL for local development
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
